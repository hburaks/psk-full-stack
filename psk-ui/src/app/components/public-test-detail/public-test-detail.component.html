<div class="container py-4" *ngIf="!isLoading">
  <!-- Test Header -->
  <div class="row" *ngIf="testTemplate && !isTestCompleted">
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-header">
          <h2 class="mb-0">{{ testTemplate.title }}</h2>
          <p class="text-muted mb-0" *ngIf="testTemplate.subTitle">{{ testTemplate.subTitle }}</p>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-8">
              <div class="progress mb-3">
                <div class="progress-bar" 
                     role="progressbar" 
                     [style.width.%]="((currentQuestionIndex + 1) / questions.length) * 100"
                     [attr.aria-valuenow]="currentQuestionIndex + 1"
                     aria-valuemin="0" 
                     [attr.aria-valuemax]="questions.length">
                  {{ currentQuestionIndex + 1 }} / {{ questions.length }}
                </div>
              </div>
            </div>
            <div class="col-md-4 text-end">
              <span class="badge bg-primary">Soru {{ currentQuestionIndex + 1 }}</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Question Section -->
  <div class="row" *ngIf="getCurrentQuestion() && !isTestCompleted">
    <div class="col-12">
      <div class="card mb-4">
        <div class="card-body">
          <h4 class="card-title mb-4">{{ getCurrentQuestion()?.text }}</h4>
          
          <!-- Answer Choices -->
          <div class="row" *ngIf="getCurrentQuestion()?.choices">
            <div class="col-12">
              <div class="list-group">
                <label 
                  *ngFor="let choice of getCurrentQuestion()!.choices" 
                  class="list-group-item list-group-item-action"
                  [class.active]="getAnswerForCurrentQuestion() === choice.answerType">
                  <input 
                    type="radio" 
                    [name]="'question_' + currentQuestionIndex"
                    [value]="choice.answerType"
                    (change)="selectAnswer(choice.answerType!)"
                    [checked]="getAnswerForCurrentQuestion() === choice.answerType"
                    class="form-check-input me-3">
                  <span class="fw-bold me-2">{{ choice.answerType | answerTypeDisplay }})</span>
                  {{ choice.text }}
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Navigation Buttons -->
  <div class="row" *ngIf="!isTestCompleted">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-center">
            <button 
              class="btn btn-outline-secondary"
              (click)="previousQuestion()"
              [disabled]="currentQuestionIndex === 0">
              <i class="fas fa-chevron-left me-2"></i>Önceki
            </button>

            <!-- Question Navigation Dots -->
            <div class="d-flex flex-wrap gap-2">
              <button 
                *ngFor="let question of questions; let i = index"
                class="btn btn-sm rounded-circle"
                [class.btn-primary]="i === currentQuestionIndex"
                [class.btn-success]="i !== currentQuestionIndex && answers[i].answerType"
                [class.btn-outline-secondary]="i !== currentQuestionIndex && !answers[i].answerType"
                (click)="goToQuestion(i)"
                style="width: 35px; height: 35px;">
                {{ i + 1 }}
              </button>
            </div>

            <div>
              <button 
                *ngIf="!isLastQuestion()"
                class="btn btn-primary"
                (click)="nextQuestion()"
                [disabled]="!canProceed()">
                Sonraki<i class="fas fa-chevron-right ms-2"></i>
              </button>
              
              <button 
                *ngIf="isLastQuestion()"
                class="btn btn-success"
                (click)="submitTest()"
                [disabled]="!allQuestionsAnswered()">
                <i class="fas fa-check me-2"></i>Testi Tamamla
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Personal Notes Section (only on last question) -->
  <div class="row mt-3" *ngIf="isLastQuestion() && !isTestCompleted">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">İsteğe Bağlı Notlar</h5>
        </div>
        <div class="card-body">
          <textarea 
            class="form-control" 
            rows="3" 
            placeholder="Bu test hakkında düşüncelerinizi veya notlarınızı buraya yazabilirsiniz (isteğe bağlı)..."
            [(ngModel)]="personalNotes">
          </textarea>
        </div>
      </div>
    </div>
  </div>

  <!-- Test Results -->
  <div class="row" *ngIf="isTestCompleted && testResult">
    <div class="col-12">
      <div class="card">
        <div class="card-header bg-success text-white">
          <h3 class="mb-0"><i class="fas fa-check-circle me-2"></i>Test Tamamlandı!</h3>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <h4>{{ testResult.testTitle }}</h4>
              <p class="text-muted">{{ testResult.submittedAt | date:'dd.MM.yyyy HH:mm' }}</p>
              
              <div class="mb-3">
                <strong>Skorunuz:</strong> 
                <span class="badge bg-primary fs-6 ms-2">{{ testResult.score }}</span>
              </div>
              
              <div class="mb-3">
                <strong>Yanıtlanan Sorular:</strong> 
                {{ testResult.answeredQuestions }} / {{ testResult.totalQuestions }}
              </div>
            </div>
            
            <div class="col-md-6" *ngIf="testResult.comment">
              <div class="card border-info">
                <div class="card-header bg-info text-white">
                  <h5 class="mb-0">{{ testResult.comment.title }}</h5>
                </div>
                <div class="card-body">
                  <p>{{ testResult.comment.text }}</p>
                </div>
              </div>
            </div>
          </div>
          
          <div class="row mt-4">
            <div class="col-12">
              <div class="d-flex gap-3">
                <button class="btn btn-primary" (click)="restartTest()">
                  <i class="fas fa-redo me-2"></i>Testi Tekrar Çöz
                </button>
                <button class="btn btn-outline-secondary" (click)="goBackToTests()">
                  <i class="fas fa-arrow-left me-2"></i>Testlere Dön
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Loading Spinner -->
<div class="container py-5" *ngIf="isLoading">
  <div class="row justify-content-center">
    <div class="col-md-6 text-center">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Yükleniyor...</span>
      </div>
      <p class="mt-3">Test yükleniyor...</p>
    </div>
  </div>
</div>